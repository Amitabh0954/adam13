")
print("
print(file_content.strip())

# Folder: backend/user_account_management/services/
# File: password_recovery_service.py
file_content = 
# Epic Title: User Account Management System

from backend.user_account_management.repositories.user_repository import UserRepository
from backend.user_account_management.repositories.password_reset_repository import PasswordResetRepository
from backend.user_account_management.models.password_reset import PasswordReset
import uuid

class PasswordRecoveryService:
    def __init__(self, user_repository: UserRepository, password_reset_repository: PasswordResetRepository):
        self.user_repository = user_repository
        self.password_reset_repository = password_reset_repository

    def request_password_reset(self, email: str) -> PasswordReset:
        user = self.user_repository.get_user_by_email(email)
        if not user:
            raise ValueError("User not found")
        
        reset_token = str(uuid.uuid4())
        password_reset = PasswordReset(user_id=user.id, reset_token=reset_token)
        self.password_reset_repository.add_password_reset(password_reset)
        
        # Here you would normally send an email to the user with the reset link
        # send_email(user.email, f"Your password reset link: https://example.com/reset?token={reset_token}")

        return password_reset

    def reset_password(self, reset_token: str, new_password: str) -> None:
        password_reset = self.password_reset_repository.get_password_reset(reset_token)
        if not password_reset or password_reset.expires_at < datetime.utcnow():
            raise ValueError("Invalid or expired reset token")
        
        user = self.user_repository.get_user_by_id(password_reset.user_id)
        user.password = self.hash_password(new_password)
        self.user_repository.session.commit()

        self.password_reset_repository.invalidate_password_reset(reset_token)

    def hash_password(self, password: str) -> str:
        import hashlib
        return hashlib.sha256(password.encode()).hexdigest()


memory_ledger["emitted_file_paths"].append("backend/user_account_management/services/password_recovery_service.py")
memory_ledger["public_interfaces"].append("PasswordRecoveryService")
memory_ledger["imports"].append("backend/user_account_management/repositories/password_reset_repository:PasswordResetRepository")
memory_ledger["folder_file_mapping"]["backend/user_account_management/services/"].append("password_recovery_service.py")

print("